# ğŸ¨ ä¸»é¢˜ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†DemoAppNoComposeé¡¹ç›®ä¸­ä¸»é¢˜é…è‰²ç³»ç»Ÿçš„æ¶æ„è®¾è®¡ã€å®ç°åŸç†å’Œä½¿ç”¨æ–¹æ³•ã€‚è¯¥ç³»ç»ŸåŸºäºMaterial Design 3è§„èŒƒï¼Œæ”¯æŒå¤šä¸»é¢˜åˆ‡æ¢ã€æš—é»‘æ¨¡å¼ã€è·Ÿéšç³»ç»Ÿç­‰ç‰¹æ€§ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸»é¢˜ç³»ç»Ÿæ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  UIå±‚ (Presentation Layer)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ThemeSettings   â”‚  â”‚ BaseActivity    â”‚  â”‚ å„ç§Activity â”‚ â”‚
â”‚  â”‚ Activity        â”‚  â”‚ (ä¸»é¢˜åº”ç”¨)      â”‚  â”‚ (è‡ªåŠ¨ç»§æ‰¿)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç®¡ç†å±‚ (Manager Layer)                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              ThemeManager (æ ¸å¿ƒç®¡ç†å™¨)                  â”‚ â”‚
â”‚  â”‚  â€¢ ä¸»é¢˜åˆ‡æ¢é€»è¾‘                                         â”‚ â”‚
â”‚  â”‚  â€¢ æš—é»‘æ¨¡å¼ç®¡ç†                                         â”‚ â”‚
â”‚  â”‚  â€¢ ç³»ç»Ÿé…ç½®ç›‘å¬                                         â”‚ â”‚
â”‚  â”‚  â€¢ é¢œè‰²è·å–å·¥å…·                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®å±‚ (Data Layer)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ThemeDataStore  â”‚  â”‚ Theme.kt        â”‚  â”‚ æ‰©å±•å‡½æ•°     â”‚ â”‚
â”‚  â”‚ (æ•°æ®å­˜å‚¨)      â”‚  â”‚ (æ•°æ®æ¨¡å‹)      â”‚  â”‚ (ä¾¿æ·API)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  èµ„æºå±‚ (Resource Layer)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ colors.xml      â”‚  â”‚ themes.xml      â”‚  â”‚ attrs.xml    â”‚ â”‚
â”‚  â”‚ (é¢œè‰²å®šä¹‰)      â”‚  â”‚ (ä¸»é¢˜æ ·å¼)      â”‚  â”‚ (è‡ªå®šä¹‰å±æ€§) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. æ•°æ®æ¨¡å‹å±‚
- **AppTheme**: ä¸»é¢˜æšä¸¾ï¼Œå®šä¹‰3å¥—ä¸»é¢˜ï¼ˆDefaultã€Businessã€Vibrantï¼‰
- **ThemeConfig**: ä¸»é¢˜é…ç½®æ•°æ®ç±»ï¼ŒåŒ…å«å½“å‰ä¸»é¢˜ã€æš—é»‘æ¨¡å¼ã€è·Ÿéšç³»ç»Ÿç­‰è®¾ç½®

#### 2. æ•°æ®å­˜å‚¨å±‚
- **ThemeDataStore**: åŸºäºDataStoreçš„ä¸»é¢˜æ•°æ®æŒä¹…åŒ–
- **ThemeModule**: Hiltä¾èµ–æ³¨å…¥é…ç½®

#### 3. ç®¡ç†å±‚
- **ThemeManager**: æ ¸å¿ƒç®¡ç†å™¨ï¼Œè´Ÿè´£ä¸»é¢˜åˆ‡æ¢ã€æš—é»‘æ¨¡å¼ç®¡ç†ã€ç³»ç»Ÿé…ç½®ç›‘å¬

#### 4. UIå±‚
- **BaseActivity**: åŸºç±»Activityï¼Œè‡ªåŠ¨åº”ç”¨ä¸»é¢˜
- **ThemeSettingsActivity**: ä¸»é¢˜è®¾ç½®é¡µé¢
- **æ‰©å±•å‡½æ•°**: ä¾¿æ·çš„é¢œè‰²è·å–å’ŒViewè®¾ç½®æ–¹æ³•

## ğŸ”„ ä¸»é¢˜åˆ‡æ¢æµç¨‹

### æµç¨‹å›¾

```mermaid
graph TD
    A[ç”¨æˆ·é€‰æ‹©ä¸»é¢˜] --> B[ThemeSettingsActivity]
    B --> C[ThemeSettingsViewModel]
    C --> D[ThemeManager.switchTheme]
    D --> E[ThemeDataStore.saveThemeId]
    E --> F[Flowæ•°æ®æ›´æ–°]
    F --> G[BaseActivity.observeThemeChanges]
    G --> H[Activity.recreate]
    H --> I[BaseActivity.applyTheme]
    I --> J[ä¸»é¢˜åº”ç”¨å®Œæˆ]
```

### è¯¦ç»†æ­¥éª¤

1. **ç”¨æˆ·æ“ä½œ**: åœ¨ThemeSettingsActivityä¸­é€‰æ‹©ä¸»é¢˜
2. **ViewModelå¤„ç†**: ThemeSettingsViewModelæ¥æ”¶ç”¨æˆ·æ“ä½œ
3. **ç®¡ç†å™¨è°ƒç”¨**: è°ƒç”¨ThemeManager.switchTheme()æ–¹æ³•
4. **æ•°æ®æŒä¹…åŒ–**: ThemeDataStoreä¿å­˜ä¸»é¢˜IDåˆ°DataStore
5. **æ•°æ®æµæ›´æ–°**: Flowå‘å‡ºæ–°çš„ä¸»é¢˜é…ç½®æ•°æ®
6. **Activityç›‘å¬**: BaseActivityç›‘å¬åˆ°ä¸»é¢˜å˜åŒ–
7. **Activityé‡å¯**: è°ƒç”¨recreate()é‡å¯Activity
8. **ä¸»é¢˜åº”ç”¨**: åœ¨onCreateä¸­è°ƒç”¨applyTheme()åº”ç”¨æ–°ä¸»é¢˜

## ğŸŒ™ æš—é»‘æ¨¡å¼å®ç°

### å®ç°åŸç†

1. **ç³»ç»Ÿæ£€æµ‹**: é€šè¿‡Configuration.UI_MODE_NIGHT_MASKæ£€æµ‹ç³»ç»Ÿæš—é»‘æ¨¡å¼
2. **è·Ÿéšç³»ç»Ÿ**: å½“followSystem=trueæ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨ç³»ç»Ÿè®¾ç½®
3. **æ‰‹åŠ¨æ§åˆ¶**: å½“followSystem=falseæ—¶ï¼Œä½¿ç”¨ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®
4. **åŠ¨æ€åˆ‡æ¢**: ç›‘å¬ç³»ç»Ÿé…ç½®å˜åŒ–ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸»é¢˜

### é…ç½®å˜åŒ–ç›‘å¬

```kotlin
override fun onConfigurationChanged(newConfig: Configuration) {
    super.onConfigurationChanged(newConfig)
    
    val isDarkMode = (newConfig.uiMode and Configuration.UI_MODE_NIGHT_MASK) == Configuration.UI_MODE_NIGHT_YES
    
    currentThemeConfig?.let { themeConfig ->
        if (themeConfig.followSystem && themeConfig.isDarkMode != isDarkMode) {
            recreate()
        }
    }
}
```

## ğŸ¨ é¢œè‰²ç³»ç»Ÿè®¾è®¡

### é¢œè‰²å±‚çº§ä½“ç³»

åŸºäºMaterial Design 3è§„èŒƒï¼Œé‡‡ç”¨ä»¥ä¸‹é¢œè‰²å±‚çº§ï¼š

#### ä¸»è‰²ç³» (Primary Colors)
- `colorPrimary`: ä¸»è‰²
- `colorPrimaryVariant`: ä¸»è‰²å˜ä½“
- `colorOnPrimary`: ä¸»è‰²ä¸Šçš„å†…å®¹è‰²

#### æ¬¡è‰²ç³» (Secondary Colors)
- `colorSecondary`: æ¬¡è‰²
- `colorSecondaryVariant`: æ¬¡è‰²å˜ä½“
- `colorOnSecondary`: æ¬¡è‰²ä¸Šçš„å†…å®¹è‰²

#### èƒŒæ™¯è‰²ç³» (Background Colors)
- `colorBackground`: èƒŒæ™¯è‰²
- `colorSurface`: è¡¨é¢è‰²
- `colorOnBackground`: èƒŒæ™¯ä¸Šçš„å†…å®¹è‰²
- `colorOnSurface`: è¡¨é¢ä¸Šçš„å†…å®¹è‰²

#### åŠŸèƒ½è‰²ç³» (Functional Colors)
- `colorError`: é”™è¯¯è‰²
- `colorSuccess`: æˆåŠŸè‰²
- `colorWarning`: è­¦å‘Šè‰²
- `colorInfo`: ä¿¡æ¯è‰²

#### æ–‡æœ¬è‰²ç³» (Text Colors)
- `textColorPrimary`: ä¸»è¦æ–‡æœ¬è‰²
- `textColorSecondary`: æ¬¡è¦æ–‡æœ¬è‰²
- `textColorTertiary`: ç¬¬ä¸‰çº§æ–‡æœ¬è‰²
- `textColorDisabled`: ç¦ç”¨æ–‡æœ¬è‰²

### ä¸»é¢˜é…è‰²æ–¹æ¡ˆ

#### 1. Defaultä¸»é¢˜ï¼ˆé»˜è®¤ä¸»é¢˜ï¼‰
- **ä¸»è‰²**: #2196F3 (è“è‰²)
- **é£æ ¼**: ç®€æ´ç°ä»£ï¼Œé€‚åˆæ—¥å¸¸ä½¿ç”¨
- **é€‚ç”¨åœºæ™¯**: é€šç”¨åº”ç”¨ï¼Œç”¨æˆ·ç¾¤ä½“å¹¿æ³›

#### 2. Businessä¸»é¢˜ï¼ˆå•†åŠ¡ä¸»é¢˜ï¼‰
- **ä¸»è‰²**: #1976D2 (æ·±è“è‰²)
- **é£æ ¼**: ä¸“ä¸šå•†åŠ¡ï¼Œé€‚åˆåŠå…¬åœºæ™¯
- **é€‚ç”¨åœºæ™¯**: ä¼ä¸šåº”ç”¨ï¼Œå•†åŠ¡åŠå…¬

#### 3. Vibrantä¸»é¢˜ï¼ˆæ´»åŠ›ä¸»é¢˜ï¼‰
- **ä¸»è‰²**: #9C27B0 (ç´«è‰²)
- **é£æ ¼**: æ´»æ³¼æ—¶å°šï¼Œé€‚åˆå¹´è½»ç”¨æˆ·
- **é€‚ç”¨åœºæ™¯**: å¨±ä¹åº”ç”¨ï¼Œå¹´è½»ç”¨æˆ·ç¾¤ä½“

## ğŸ› ï¸ æŠ€æœ¯å®ç°ç»†èŠ‚

### ä¾èµ–æ³¨å…¥é…ç½®

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object ThemeModule {
    @Provides
    @Singleton
    fun provideThemeDataStore(dataStore: DataStore<Preferences>): ThemeDataStore {
        return ThemeDataStore(dataStore)
    }
    
    @Provides
    @Singleton
    fun provideThemeManager(
        @ApplicationContext context: Context,
        themeDataStore: ThemeDataStore
    ): ThemeManager {
        return ThemeManager(context, themeDataStore)
    }
}
```

### ä¸»é¢˜åº”ç”¨æœºåˆ¶

```kotlin
private fun applyTheme() {
    if (!::themeManager.isInitialized) {
        return
    }
    
    lifecycleScope.launch {
        themeManager.getCurrentThemeConfig().collect { themeConfig ->
            currentThemeConfig = themeConfig
            
            val isDarkMode = if (themeConfig.followSystem) {
                themeManager.isSystemDarkMode(this@BaseActivity)
            } else {
                themeConfig.isDarkMode
            }
            
            val finalThemeConfig = themeConfig.copy(isDarkMode = isDarkMode)
            themeManager.applyTheme(this@BaseActivity, finalThemeConfig)
        }
    }
}
```

### çŠ¶æ€æ é€‚é…

```kotlin
protected open fun initStatusBar() {
    val statusBarColor = getPrimaryColor()
    window.statusBarColor = statusBarColor
    
    val isLightStatusBar = isLightColor(statusBarColor)
    WindowInsetsControllerCompat(window, window.decorView).apply {
        isAppearanceLightStatusBars = isLightStatusBar
    }
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. é¢œè‰²è·å–ä¼˜åŒ–
- ä½¿ç”¨TypedValueç¼“å­˜é¢œè‰²è§£æç»“æœ
- é¿å…é‡å¤è§£æç›¸åŒå±æ€§

### 2. ä¸»é¢˜åˆ‡æ¢ä¼˜åŒ–
- ä½¿ç”¨Flowè¿›è¡Œå“åº”å¼æ•°æ®æµç®¡ç†
- é¿å…ä¸å¿…è¦çš„Activityé‡å¯

### 3. å†…å­˜ä¼˜åŒ–
- ä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†ThemeManager
- åˆç†ä½¿ç”¨DataStoreè¿›è¡Œæ•°æ®æŒä¹…åŒ–

## ğŸ”§ æ‰©å±•æ€§è®¾è®¡

### æ·»åŠ æ–°ä¸»é¢˜

1. åœ¨`AppTheme`æšä¸¾ä¸­æ·»åŠ æ–°ä¸»é¢˜
2. åœ¨`colors.xml`ä¸­å®šä¹‰æ–°ä¸»é¢˜çš„é¢œè‰²
3. åœ¨`themes.xml`ä¸­åˆ›å»ºæ–°ä¸»é¢˜æ ·å¼
4. åœ¨`ThemeSettingsActivity`ä¸­æ·»åŠ ä¸»é¢˜é€‰é¡¹

### æ·»åŠ æ–°é¢œè‰²å±æ€§

1. åœ¨`attrs.xml`ä¸­å®šä¹‰æ–°å±æ€§
2. åœ¨`themes.xml`ä¸­ä¸ºæ–°å±æ€§èµ‹å€¼
3. åœ¨`ColorExt.kt`ä¸­æ·»åŠ å¯¹åº”çš„æ‰©å±•å‡½æ•°

## ğŸ› å¸¸è§é—®é¢˜

### 1. ä¸»é¢˜åˆ‡æ¢ä¸ç”Ÿæ•ˆ
- æ£€æŸ¥Activityæ˜¯å¦ç»§æ‰¿è‡ªBaseActivity
- ç¡®è®¤ThemeManageræ˜¯å¦æ­£ç¡®æ³¨å…¥
- éªŒè¯ä¸»é¢˜èµ„æºæ–‡ä»¶æ˜¯å¦æ­£ç¡®é…ç½®

### 2. æš—é»‘æ¨¡å¼ä¸è·Ÿéšç³»ç»Ÿ
- æ£€æŸ¥followSystemè®¾ç½®æ˜¯å¦æ­£ç¡®ä¿å­˜
- ç¡®è®¤onConfigurationChangedæ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨
- éªŒè¯ç³»ç»Ÿæš—é»‘æ¨¡å¼æ£€æµ‹é€»è¾‘

### 3. çŠ¶æ€æ é¢œè‰²ä¸æ­£ç¡®
- æ£€æŸ¥initStatusBaræ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨
- ç¡®è®¤ä¸»è‰²è·å–æ˜¯å¦æ­£ç¡®
- éªŒè¯çŠ¶æ€æ å›¾æ ‡é¢œè‰²è®¡ç®—é€»è¾‘

## ğŸ“ˆ æœªæ¥è§„åˆ’

### çŸ­æœŸç›®æ ‡
- æ·»åŠ æ›´å¤šä¸»é¢˜é…è‰²æ–¹æ¡ˆ
- ä¼˜åŒ–ä¸»é¢˜åˆ‡æ¢åŠ¨ç”»æ•ˆæœ
- å¢åŠ ä¸»é¢˜é¢„è§ˆåŠŸèƒ½

### é•¿æœŸç›®æ ‡
- æ”¯æŒè‡ªå®šä¹‰ä¸»é¢˜åˆ›å»º
- æ·»åŠ ä¸»é¢˜å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
- å®ç°ä¸»é¢˜å¸‚åœºåŠŸèƒ½

---

*æœ¬æ–‡æ¡£æœ€åæ›´æ–°æ—¶é—´: 2024å¹´10æœˆ*
