# ğŸ¨ ä¸»é¢˜ç³»ç»Ÿç¤ºä¾‹ä»£ç 

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†ä¸»é¢˜é…è‰²ç³»ç»Ÿçš„å®Œæ•´ç¤ºä¾‹ä»£ç ï¼ŒåŒ…æ‹¬Activityã€Fragmentã€è‡ªå®šä¹‰Viewã€Dialogç­‰å„ç§åœºæ™¯çš„ä½¿ç”¨ç¤ºä¾‹ã€‚

## ğŸ—ï¸ åŸºç¡€ç¤ºä¾‹

### 1. åŸºç¡€Activityç¤ºä¾‹

```kotlin
@AndroidEntryPoint
class ExampleActivity : BaseActivity<ActivityExampleBinding>() {
    
    override val bindingInflater = ActivityExampleBinding::inflate
    
    @Inject
    lateinit var injectedThemeManager: ThemeManager
    
    override fun initView() {
        // åˆå§‹åŒ–BaseActivityçš„themeManager
        super.themeManager = injectedThemeManager
        
        setupToolbar()
        setupViews()
    }
    
    private fun setupToolbar() {
        binding.titleBar.apply {
            setTitle("ç¤ºä¾‹é¡µé¢")
            // TitleBaré»˜è®¤å°±æœ‰è¿”å›æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        }
    }
    
    private fun setupViews() {
        // ä½¿ç”¨ä¸»é¢˜é¢œè‰²è®¾ç½®View
        binding.textView.setThemeTextColor()
        binding.imageView.setThemeTint()
        binding.button.setBackgroundResource(R.drawable.bg_button_primary_pressed)
    }
}
```

### 2. åŸºç¡€å¸ƒå±€ç¤ºä¾‹

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="?attr/colorBackground"
    android:orientation="vertical"
    android:padding="16dp">

    <!-- æ ‡é¢˜æ  -->
    <include
        android:id="@+id/titleBar"
        layout="@layout/layout_title_bar" />

    <!-- ä¸»è¦å†…å®¹ -->
    <ScrollView
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1">

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="vertical">

            <!-- å¡ç‰‡ç¤ºä¾‹ -->
            <androidx.cardview.CardView
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_marginBottom="16dp"
                android:background="?attr/colorSurface"
                app:cardCornerRadius="8dp"
                app:cardElevation="2dp">

                <LinearLayout
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:orientation="vertical"
                    android:padding="16dp">

                    <TextView
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:text="å¡ç‰‡æ ‡é¢˜"
                        android:textColor="?attr/textColorPrimary"
                        android:textSize="18sp"
                        android:textStyle="bold" />

                    <TextView
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:layout_marginTop="8dp"
                        android:text="è¿™æ˜¯å¡ç‰‡å†…å®¹ï¼Œå±•ç¤ºä¸»é¢˜é¢œè‰²çš„ä½¿ç”¨"
                        android:textColor="?attr/textColorSecondary"
                        android:textSize="14sp" />

                </LinearLayout>

            </androidx.cardview.CardView>

            <!-- æŒ‰é’®ç¤ºä¾‹ -->
            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="horizontal"
                android:gravity="center">

                <Button
                    android:id="@+id/btnPrimary"
                    android:layout_width="0dp"
                    android:layout_height="wrap_content"
                    android:layout_weight="1"
                    android:layout_marginEnd="8dp"
                    android:text="ä¸»è¦æŒ‰é’®"
                    android:textColor="?attr/colorOnPrimary"
                    android:background="@drawable/bg_button_primary_pressed" />

                <Button
                    android:id="@+id/btnSecondary"
                    android:layout_width="0dp"
                    android:layout_height="wrap_content"
                    android:layout_weight="1"
                    android:layout_marginStart="8dp"
                    android:text="æ¬¡è¦æŒ‰é’®"
                    android:textColor="?attr/colorOnSecondary"
                    android:background="@drawable/bg_secondary_rounded" />

            </LinearLayout>

        </LinearLayout>

    </ScrollView>

</LinearLayout>
```

## ğŸ¨ é«˜çº§ç¤ºä¾‹

### 1. ä¸»é¢˜è®¾ç½®Activityå®Œæ•´ç¤ºä¾‹

```kotlin
@AndroidEntryPoint
class ThemeSettingsActivity : BaseActivity<ActivityThemeSettingsBinding>() {

    override val bindingInflater = ActivityThemeSettingsBinding::inflate

    private val settingsViewModel: ThemeSettingsViewModel by viewModels()

    @Inject
    lateinit var injectedThemeManager: ThemeManager

    override fun initView() {
        super.themeManager = injectedThemeManager
        setupToolbar()
        setupThemeSelection()
        setupDarkModeSwitch()
        setupFollowSystemSwitch()
    }

    override fun initData() {
        observeThemeConfig()
    }

    private fun setupToolbar() {
        binding.titleBar.apply {
            setTitle("ä¸»é¢˜è®¾ç½®")
        }
    }

    private fun setupThemeSelection() {
        binding.radioGroupTheme.setOnCheckedChangeListener { _, checkedId ->
            val theme = when (checkedId) {
                R.id.rbDefault -> AppTheme.DEFAULT
                R.id.rbBusiness -> AppTheme.BUSINESS
                R.id.rbVibrant -> AppTheme.VIBRANT
                else -> AppTheme.DEFAULT
            }
            lifecycleScope.launch {
                settingsViewModel.switchTheme(theme)
            }
        }
    }

    private fun setupDarkModeSwitch() {
        binding.switchDarkMode.setOnCheckedChangeListener { _, isChecked ->
            lifecycleScope.launch {
                settingsViewModel.switchDarkMode(isChecked)
            }
        }
    }

    private fun setupFollowSystemSwitch() {
        binding.switchFollowSystem.setOnCheckedChangeListener { _, isChecked ->
            lifecycleScope.launch {
                settingsViewModel.setFollowSystem(isChecked)
            }
        }
    }

    private fun observeThemeConfig() {
        lifecycleScope.launch {
            settingsViewModel.themeConfig.collect { themeConfig ->
                updateThemeSelection(themeConfig.currentTheme)
                updateDarkModeSwitch(themeConfig.isDarkMode)
                updateFollowSystemSwitch(themeConfig.followSystem)
            }
        }
    }

    private fun updateThemeSelection(theme: AppTheme) {
        val radioButtonId = when (theme) {
            AppTheme.DEFAULT -> R.id.rbDefault
            AppTheme.BUSINESS -> R.id.rbBusiness
            AppTheme.VIBRANT -> R.id.rbVibrant
        }
        binding.radioGroupTheme.check(radioButtonId)
    }

    private fun updateDarkModeSwitch(isDarkMode: Boolean) {
        binding.switchDarkMode.isChecked = isDarkMode
    }

    private fun updateFollowSystemSwitch(followSystem: Boolean) {
        binding.switchFollowSystem.isChecked = followSystem
        binding.switchDarkMode.isEnabled = !followSystem
    }
}
```

### 2. è‡ªå®šä¹‰ä¸»é¢˜åŒ–Viewç¤ºä¾‹

```kotlin
class ThemeCardView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : CardView(context, attrs, defStyleAttr) {

    private var themeManager: ThemeManager? = null

    fun setThemeManager(themeManager: ThemeManager) {
        this.themeManager = themeManager
        updateTheme()
    }

    private fun updateTheme() {
        themeManager?.let { manager ->
            // è®¾ç½®å¡ç‰‡èƒŒæ™¯è‰²
            setCardBackgroundColor(manager.getThemeColor(context, R.attr.colorSurface))
            
            // è®¾ç½®å¡ç‰‡è¾¹æ¡†è‰²
            strokeColor = manager.getThemeColor(context, R.attr.colorBorder)
            
            // è®¾ç½®å¡ç‰‡é˜´å½±è‰²
            setCardElevation(4f)
        }
    }

    override fun onAttachedToWindow() {
        super.onAttachedToWindow()
        updateTheme()
    }
}
```

### 3. ä¸»é¢˜åŒ–Dialogç¤ºä¾‹

```kotlin
class ThemeDialog @JvmOverloads constructor(
    context: Context,
    theme: Int = 0
) : Dialog(context, theme) {

    private lateinit var themeManager: ThemeManager

    fun setThemeManager(themeManager: ThemeManager) {
        this.themeManager = themeManager
        applyTheme()
    }

    private fun applyTheme() {
        // è®¾ç½®DialogèƒŒæ™¯
        window?.setBackgroundDrawableResource(R.drawable.bg_surface_rounded)
        
        // è®¾ç½®Dialogæ ‡é¢˜é¢œè‰²
        findViewById<TextView>(R.id.tvTitle)?.setTextColor(
            themeManager.getThemeColor(context, R.attr.textColorPrimary)
        )
        
        // è®¾ç½®Dialogå†…å®¹é¢œè‰²
        findViewById<TextView>(R.id.tvContent)?.setTextColor(
            themeManager.getThemeColor(context, R.attr.textColorSecondary)
        )
        
        // è®¾ç½®æŒ‰é’®é¢œè‰²
        findViewById<Button>(R.id.btnConfirm)?.apply {
            setTextColor(themeManager.getThemeColor(context, R.attr.colorOnPrimary))
            setBackgroundColor(themeManager.getThemeColor(context, R.attr.colorPrimary))
        }
        
        findViewById<Button>(R.id.btnCancel)?.apply {
            setTextColor(themeManager.getThemeColor(context, R.attr.textColorSecondary))
            setBackgroundColor(themeManager.getThemeColor(context, R.attr.colorSurface))
        }
    }

    override fun show() {
        super.show()
        applyTheme()
    }
}
```

## ğŸ¯ å®ç”¨å·¥å…·ç¤ºä¾‹

### 1. é¢œè‰²å·¥å…·ç±»

```kotlin
object ColorUtils {
    
    /**
     * åˆ¤æ–­é¢œè‰²æ˜¯å¦ä¸ºæµ…è‰²
     */
    fun isLightColor(color: Int): Boolean {
        val red = (color shr 16) and 0xFF
        val green = (color shr 8) and 0xFF
        val blue = color and 0xFF
        
        val luminance = (0.299 * red + 0.587 * green + 0.114 * blue) / 255
        return luminance > 0.5
    }
    
    /**
     * è°ƒæ•´é¢œè‰²é€æ˜åº¦
     */
    fun adjustAlpha(color: Int, alpha: Float): Int {
        val alphaInt = (alpha * 255).toInt().coerceIn(0, 255)
        return (color and 0x00FFFFFF) or (alphaInt shl 24)
    }
    
    /**
     * é¢œè‰²åŠ æ·±
     */
    fun darkenColor(color: Int, factor: Float): Int {
        val factor = factor.coerceIn(0f, 1f)
        val alpha = (color shr 24) and 0xFF
        val red = ((color shr 16) and 0xFF) * (1 - factor)
        val green = ((color shr 8) and 0xFF) * (1 - factor)
        val blue = (color and 0xFF) * (1 - factor)
        return (alpha shl 24) or (red.toInt() shl 16) or (green.toInt() shl 8) or blue.toInt()
    }
    
    /**
     * é¢œè‰²å‡æ·¡
     */
    fun lightenColor(color: Int, factor: Float): Int {
        val factor = factor.coerceIn(0f, 1f)
        val alpha = (color shr 24) and 0xFF
        val red = ((color shr 16) and 0xFF) + (255 - ((color shr 16) and 0xFF)) * factor
        val green = ((color shr 8) and 0xFF) + (255 - ((color shr 8) and 0xFF)) * factor
        val blue = (color and 0xFF) + (255 - (color and 0xFF)) * factor
        return (alpha shl 24) or (red.toInt() shl 16) or (green.toInt() shl 8) or blue.toInt()
    }
}
```

### 2. ä¸»é¢˜çŠ¶æ€ç®¡ç†

```kotlin
class ThemeStateManager(private val themeManager: ThemeManager) {
    
    private val _currentTheme = MutableStateFlow(ThemeConfig())
    val currentTheme: StateFlow<ThemeConfig> = _currentTheme.asStateFlow()
    
    init {
        observeThemeChanges()
    }
    
    private fun observeThemeChanges() {
        CoroutineScope(Dispatchers.Main).launch {
            themeManager.getCurrentThemeConfig().collect { themeConfig ->
                _currentTheme.value = themeConfig
            }
        }
    }
    
    suspend fun switchTheme(theme: AppTheme) {
        themeManager.switchTheme(theme)
    }
    
    suspend fun switchDarkMode(isDarkMode: Boolean) {
        themeManager.switchDarkMode(isDarkMode)
    }
    
    suspend fun setFollowSystem(followSystem: Boolean) {
        themeManager.setFollowSystem(followSystem)
    }
}
```

### 3. ä¸»é¢˜åŒ–RecyclerViewé€‚é…å™¨

```kotlin
class ThemeAdapter(
    private val themeManager: ThemeManager
) : RecyclerView.Adapter<ThemeAdapter.ViewHolder>() {
    
    private var items: List<String> = emptyList()
    
    fun updateItems(newItems: List<String>) {
        items = newItems
        notifyDataSetChanged()
    }
    
    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ViewHolder {
        val view = LayoutInflater.from(parent.context)
            .inflate(R.layout.item_theme, parent, false)
        return ViewHolder(view)
    }
    
    override fun onBindViewHolder(holder: ViewHolder, position: Int) {
        holder.bind(items[position])
    }
    
    override fun getItemCount(): Int = items.size
    
    inner class ViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {
        
        private val textView: TextView = itemView.findViewById(R.id.tvItem)
        private val cardView: CardView = itemView.findViewById(R.id.cardView)
        
        fun bind(item: String) {
            textView.text = item
            
            // åº”ç”¨ä¸»é¢˜é¢œè‰²
            textView.setTextColor(themeManager.getThemeColor(itemView.context, R.attr.textColorPrimary))
            cardView.setCardBackgroundColor(themeManager.getThemeColor(itemView.context, R.attr.colorSurface))
            cardView.strokeColor = themeManager.getThemeColor(itemView.context, R.attr.colorBorder)
        }
    }
}
```

## ğŸ“± å®Œæ•´åº”ç”¨ç¤ºä¾‹

### 1. ä¸»Activityç¤ºä¾‹

```kotlin
@AndroidEntryPoint
class MainActivity : BaseActivity<ActivityMainBinding>() {
    
    override val bindingInflater = ActivityMainBinding::inflate
    
    @Inject
    lateinit var injectedThemeManager: ThemeManager
    
    override fun initView() {
        super.themeManager = injectedThemeManager
        setupViews()
        setupClickListeners()
    }
    
    private fun setupViews() {
        // è®¾ç½®ä¸»é¢˜é¢œè‰²
        binding.textView.setThemeTextColor()
        binding.imageView.setThemeTint()
        binding.button.setBackgroundResource(R.drawable.bg_button_primary_pressed)
    }
    
    private fun setupClickListeners() {
        binding.button.setOnClickListener {
            // è·³è½¬åˆ°ä¸»é¢˜è®¾ç½®é¡µé¢
            startActivity(Intent(this, ThemeSettingsActivity::class.java))
        }
    }
}
```

### 2. ä¸»é¢˜è®¾ç½®å¸ƒå±€ç¤ºä¾‹

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="?attr/colorBackground"
    android:orientation="vertical">

    <!-- æ ‡é¢˜æ  -->
    <include
        android:id="@+id/titleBar"
        layout="@layout/layout_title_bar" />

    <!-- æ»šåŠ¨å†…å®¹ -->
    <ScrollView
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:fillViewport="true">

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            android:padding="16dp">

            <!-- ä¸»é¢˜é€‰æ‹© -->
            <TextView
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="ä¸»é¢˜é€‰æ‹©"
                android:textColor="?attr/textColorPrimary"
                android:textSize="18sp"
                android:textStyle="bold" />

            <RadioGroup
                android:id="@+id/radioGroupTheme"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_marginTop="16dp"
                android:orientation="vertical">

                <RadioButton
                    android:id="@+id/rbDefault"
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:layout_marginBottom="8dp"
                    android:background="@drawable/bg_surface_rounded"
                    android:padding="16dp"
                    android:text="é»˜è®¤ä¸»é¢˜"
                    android:textColor="?attr/textColorPrimary"
                    android:textSize="16sp" />

                <RadioButton
                    android:id="@+id/rbBusiness"
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:layout_marginBottom="8dp"
                    android:background="@drawable/bg_surface_rounded"
                    android:padding="16dp"
                    android:text="å•†åŠ¡ä¸»é¢˜"
                    android:textColor="?attr/textColorPrimary"
                    android:textSize="16sp" />

                <RadioButton
                    android:id="@+id/rbVibrant"
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:background="@drawable/bg_surface_rounded"
                    android:padding="16dp"
                    android:text="æ´»åŠ›ä¸»é¢˜"
                    android:textColor="?attr/textColorPrimary"
                    android:textSize="16sp" />

            </RadioGroup>

            <!-- æš—é»‘æ¨¡å¼è®¾ç½® -->
            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_marginTop="32dp"
                android:background="@drawable/bg_surface_rounded"
                android:gravity="center_vertical"
                android:padding="16dp">

                <LinearLayout
                    android:layout_width="0dp"
                    android:layout_height="wrap_content"
                    android:layout_weight="1"
                    android:orientation="vertical">

                    <TextView
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:text="æš—é»‘æ¨¡å¼"
                        android:textColor="?attr/textColorPrimary"
                        android:textSize="16sp" />

                    <TextView
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:layout_marginTop="4dp"
                        android:text="å¯ç”¨æš—é»‘æ¨¡å¼"
                        android:textColor="?attr/textColorSecondary"
                        android:textSize="14sp" />

                </LinearLayout>

                <Switch
                    android:id="@+id/switchDarkMode"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content" />

            </LinearLayout>

        </LinearLayout>

    </ScrollView>

</LinearLayout>
```

## ğŸ”§ è°ƒè¯•å’Œæµ‹è¯•ç¤ºä¾‹

### 1. ä¸»é¢˜æµ‹è¯•å·¥å…·

```kotlin
class ThemeTestHelper(private val context: Context) {
    
    fun testAllThemes() {
        val themes = listOf(AppTheme.DEFAULT, AppTheme.BUSINESS, AppTheme.VIBRANT)
        
        themes.forEach { theme ->
            Log.d("ThemeTest", "Testing theme: ${theme.themeName}")
            testThemeColors(theme)
        }
    }
    
    private fun testThemeColors(theme: AppTheme) {
        // æµ‹è¯•ä¸»è‰²
        val primaryColor = context.getPrimaryColor()
        Log.d("ThemeTest", "Primary color: ${Integer.toHexString(primaryColor)}")
        
        // æµ‹è¯•æ–‡æœ¬è‰²
        val textColor = context.getTextPrimaryColor()
        Log.d("ThemeTest", "Text color: ${Integer.toHexString(textColor)}")
        
        // æµ‹è¯•èƒŒæ™¯è‰²
        val backgroundColor = context.getBackgroundColor()
        Log.d("ThemeTest", "Background color: ${Integer.toHexString(backgroundColor)}")
    }
}
```

### 2. é¢œè‰²å¯¹æ¯”åº¦æµ‹è¯•

```kotlin
class ContrastTestHelper {
    
    fun testContrastRatio(foreground: Int, background: Int): Double {
        val fgLuminance = getLuminance(foreground)
        val bgLuminance = getLuminance(background)
        
        val lighter = maxOf(fgLuminance, bgLuminance)
        val darker = minOf(fgLuminance, bgLuminance)
        
        return (lighter + 0.05) / (darker + 0.05)
    }
    
    private fun getLuminance(color: Int): Double {
        val red = (color shr 16) and 0xFF
        val green = (color shr 8) and 0xFF
        val blue = color and 0xFF
        
        val r = red / 255.0
        val g = green / 255.0
        val b = blue / 255.0
        
        val rLinear = if (r <= 0.03928) r / 12.92 else Math.pow((r + 0.055) / 1.055, 2.4)
        val gLinear = if (g <= 0.03928) g / 12.92 else Math.pow((g + 0.055) / 1.055, 2.4)
        val bLinear = if (b <= 0.03928) b / 12.92 else Math.pow((b + 0.055) / 1.055, 2.4)
        
        return 0.2126 * rLinear + 0.7152 * gLinear + 0.0722 * bLinear
    }
}
```

---

*æœ¬æ–‡æ¡£æœ€åæ›´æ–°æ—¶é—´: 2024å¹´10æœˆ*
