# 🎨 主题系统示例代码

## 📋 概述

本文档提供了主题配色系统的完整示例代码，包括Activity、Fragment、自定义View、Dialog等各种场景的使用示例。

## 🏗️ 基础示例

### 1. 基础Activity示例

```kotlin
@AndroidEntryPoint
class ExampleActivity : BaseActivity<ActivityExampleBinding>() {
    
    override val bindingInflater = ActivityExampleBinding::inflate
    
    @Inject
    lateinit var injectedThemeManager: ThemeManager
    
    override fun initView() {
        // 初始化BaseActivity的themeManager
        super.themeManager = injectedThemeManager
        
        setupToolbar()
        setupViews()
    }
    
    private fun setupToolbar() {
        binding.titleBar.apply {
            setTitle("示例页面")
            // TitleBar默认就有返回按钮的点击事件
        }
    }
    
    private fun setupViews() {
        // 使用主题颜色设置View
        binding.textView.setThemeTextColor()
        binding.imageView.setThemeTint()
        binding.button.setBackgroundResource(R.drawable.bg_button_primary_pressed)
    }
}
```

### 2. 基础布局示例

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="?attr/colorBackground"
    android:orientation="vertical"
    android:padding="16dp">

    <!-- 标题栏 -->
    <include
        android:id="@+id/titleBar"
        layout="@layout/layout_title_bar" />

    <!-- 主要内容 -->
    <ScrollView
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1">

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="vertical">

            <!-- 卡片示例 -->
            <androidx.cardview.CardView
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_marginBottom="16dp"
                android:background="?attr/colorSurface"
                app:cardCornerRadius="8dp"
                app:cardElevation="2dp">

                <LinearLayout
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:orientation="vertical"
                    android:padding="16dp">

                    <TextView
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:text="卡片标题"
                        android:textColor="?attr/textColorPrimary"
                        android:textSize="18sp"
                        android:textStyle="bold" />

                    <TextView
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:layout_marginTop="8dp"
                        android:text="这是卡片内容，展示主题颜色的使用"
                        android:textColor="?attr/textColorSecondary"
                        android:textSize="14sp" />

                </LinearLayout>

            </androidx.cardview.CardView>

            <!-- 按钮示例 -->
            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="horizontal"
                android:gravity="center">

                <Button
                    android:id="@+id/btnPrimary"
                    android:layout_width="0dp"
                    android:layout_height="wrap_content"
                    android:layout_weight="1"
                    android:layout_marginEnd="8dp"
                    android:text="主要按钮"
                    android:textColor="?attr/colorOnPrimary"
                    android:background="@drawable/bg_button_primary_pressed" />

                <Button
                    android:id="@+id/btnSecondary"
                    android:layout_width="0dp"
                    android:layout_height="wrap_content"
                    android:layout_weight="1"
                    android:layout_marginStart="8dp"
                    android:text="次要按钮"
                    android:textColor="?attr/colorOnSecondary"
                    android:background="@drawable/bg_secondary_rounded" />

            </LinearLayout>

        </LinearLayout>

    </ScrollView>

</LinearLayout>
```

## 🎨 高级示例

### 1. 主题设置Activity完整示例

```kotlin
@AndroidEntryPoint
class ThemeSettingsActivity : BaseActivity<ActivityThemeSettingsBinding>() {

    override val bindingInflater = ActivityThemeSettingsBinding::inflate

    private val settingsViewModel: ThemeSettingsViewModel by viewModels()

    @Inject
    lateinit var injectedThemeManager: ThemeManager

    override fun initView() {
        super.themeManager = injectedThemeManager
        setupToolbar()
        setupThemeSelection()
        setupDarkModeSwitch()
        setupFollowSystemSwitch()
    }

    override fun initData() {
        observeThemeConfig()
    }

    private fun setupToolbar() {
        binding.titleBar.apply {
            setTitle("主题设置")
        }
    }

    private fun setupThemeSelection() {
        binding.radioGroupTheme.setOnCheckedChangeListener { _, checkedId ->
            val theme = when (checkedId) {
                R.id.rbDefault -> AppTheme.DEFAULT
                R.id.rbBusiness -> AppTheme.BUSINESS
                R.id.rbVibrant -> AppTheme.VIBRANT
                else -> AppTheme.DEFAULT
            }
            lifecycleScope.launch {
                settingsViewModel.switchTheme(theme)
            }
        }
    }

    private fun setupDarkModeSwitch() {
        binding.switchDarkMode.setOnCheckedChangeListener { _, isChecked ->
            lifecycleScope.launch {
                settingsViewModel.switchDarkMode(isChecked)
            }
        }
    }

    private fun setupFollowSystemSwitch() {
        binding.switchFollowSystem.setOnCheckedChangeListener { _, isChecked ->
            lifecycleScope.launch {
                settingsViewModel.setFollowSystem(isChecked)
            }
        }
    }

    private fun observeThemeConfig() {
        lifecycleScope.launch {
            settingsViewModel.themeConfig.collect { themeConfig ->
                updateThemeSelection(themeConfig.currentTheme)
                updateDarkModeSwitch(themeConfig.isDarkMode)
                updateFollowSystemSwitch(themeConfig.followSystem)
            }
        }
    }

    private fun updateThemeSelection(theme: AppTheme) {
        val radioButtonId = when (theme) {
            AppTheme.DEFAULT -> R.id.rbDefault
            AppTheme.BUSINESS -> R.id.rbBusiness
            AppTheme.VIBRANT -> R.id.rbVibrant
        }
        binding.radioGroupTheme.check(radioButtonId)
    }

    private fun updateDarkModeSwitch(isDarkMode: Boolean) {
        binding.switchDarkMode.isChecked = isDarkMode
    }

    private fun updateFollowSystemSwitch(followSystem: Boolean) {
        binding.switchFollowSystem.isChecked = followSystem
        binding.switchDarkMode.isEnabled = !followSystem
    }
}
```

### 2. 自定义主题化View示例

```kotlin
class ThemeCardView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : CardView(context, attrs, defStyleAttr) {

    private var themeManager: ThemeManager? = null

    fun setThemeManager(themeManager: ThemeManager) {
        this.themeManager = themeManager
        updateTheme()
    }

    private fun updateTheme() {
        themeManager?.let { manager ->
            // 设置卡片背景色
            setCardBackgroundColor(manager.getThemeColor(context, R.attr.colorSurface))
            
            // 设置卡片边框色
            strokeColor = manager.getThemeColor(context, R.attr.colorBorder)
            
            // 设置卡片阴影色
            setCardElevation(4f)
        }
    }

    override fun onAttachedToWindow() {
        super.onAttachedToWindow()
        updateTheme()
    }
}
```

### 3. 主题化Dialog示例

```kotlin
class ThemeDialog @JvmOverloads constructor(
    context: Context,
    theme: Int = 0
) : Dialog(context, theme) {

    private lateinit var themeManager: ThemeManager

    fun setThemeManager(themeManager: ThemeManager) {
        this.themeManager = themeManager
        applyTheme()
    }

    private fun applyTheme() {
        // 设置Dialog背景
        window?.setBackgroundDrawableResource(R.drawable.bg_surface_rounded)
        
        // 设置Dialog标题颜色
        findViewById<TextView>(R.id.tvTitle)?.setTextColor(
            themeManager.getThemeColor(context, R.attr.textColorPrimary)
        )
        
        // 设置Dialog内容颜色
        findViewById<TextView>(R.id.tvContent)?.setTextColor(
            themeManager.getThemeColor(context, R.attr.textColorSecondary)
        )
        
        // 设置按钮颜色
        findViewById<Button>(R.id.btnConfirm)?.apply {
            setTextColor(themeManager.getThemeColor(context, R.attr.colorOnPrimary))
            setBackgroundColor(themeManager.getThemeColor(context, R.attr.colorPrimary))
        }
        
        findViewById<Button>(R.id.btnCancel)?.apply {
            setTextColor(themeManager.getThemeColor(context, R.attr.textColorSecondary))
            setBackgroundColor(themeManager.getThemeColor(context, R.attr.colorSurface))
        }
    }

    override fun show() {
        super.show()
        applyTheme()
    }
}
```

## 🎯 实用工具示例

### 1. 颜色工具类

```kotlin
object ColorUtils {
    
    /**
     * 判断颜色是否为浅色
     */
    fun isLightColor(color: Int): Boolean {
        val red = (color shr 16) and 0xFF
        val green = (color shr 8) and 0xFF
        val blue = color and 0xFF
        
        val luminance = (0.299 * red + 0.587 * green + 0.114 * blue) / 255
        return luminance > 0.5
    }
    
    /**
     * 调整颜色透明度
     */
    fun adjustAlpha(color: Int, alpha: Float): Int {
        val alphaInt = (alpha * 255).toInt().coerceIn(0, 255)
        return (color and 0x00FFFFFF) or (alphaInt shl 24)
    }
    
    /**
     * 颜色加深
     */
    fun darkenColor(color: Int, factor: Float): Int {
        val factor = factor.coerceIn(0f, 1f)
        val alpha = (color shr 24) and 0xFF
        val red = ((color shr 16) and 0xFF) * (1 - factor)
        val green = ((color shr 8) and 0xFF) * (1 - factor)
        val blue = (color and 0xFF) * (1 - factor)
        return (alpha shl 24) or (red.toInt() shl 16) or (green.toInt() shl 8) or blue.toInt()
    }
    
    /**
     * 颜色减淡
     */
    fun lightenColor(color: Int, factor: Float): Int {
        val factor = factor.coerceIn(0f, 1f)
        val alpha = (color shr 24) and 0xFF
        val red = ((color shr 16) and 0xFF) + (255 - ((color shr 16) and 0xFF)) * factor
        val green = ((color shr 8) and 0xFF) + (255 - ((color shr 8) and 0xFF)) * factor
        val blue = (color and 0xFF) + (255 - (color and 0xFF)) * factor
        return (alpha shl 24) or (red.toInt() shl 16) or (green.toInt() shl 8) or blue.toInt()
    }
}
```

### 2. 主题状态管理

```kotlin
class ThemeStateManager(private val themeManager: ThemeManager) {
    
    private val _currentTheme = MutableStateFlow(ThemeConfig())
    val currentTheme: StateFlow<ThemeConfig> = _currentTheme.asStateFlow()
    
    init {
        observeThemeChanges()
    }
    
    private fun observeThemeChanges() {
        CoroutineScope(Dispatchers.Main).launch {
            themeManager.getCurrentThemeConfig().collect { themeConfig ->
                _currentTheme.value = themeConfig
            }
        }
    }
    
    suspend fun switchTheme(theme: AppTheme) {
        themeManager.switchTheme(theme)
    }
    
    suspend fun switchDarkMode(isDarkMode: Boolean) {
        themeManager.switchDarkMode(isDarkMode)
    }
    
    suspend fun setFollowSystem(followSystem: Boolean) {
        themeManager.setFollowSystem(followSystem)
    }
}
```

### 3. 主题化RecyclerView适配器

```kotlin
class ThemeAdapter(
    private val themeManager: ThemeManager
) : RecyclerView.Adapter<ThemeAdapter.ViewHolder>() {
    
    private var items: List<String> = emptyList()
    
    fun updateItems(newItems: List<String>) {
        items = newItems
        notifyDataSetChanged()
    }
    
    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ViewHolder {
        val view = LayoutInflater.from(parent.context)
            .inflate(R.layout.item_theme, parent, false)
        return ViewHolder(view)
    }
    
    override fun onBindViewHolder(holder: ViewHolder, position: Int) {
        holder.bind(items[position])
    }
    
    override fun getItemCount(): Int = items.size
    
    inner class ViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {
        
        private val textView: TextView = itemView.findViewById(R.id.tvItem)
        private val cardView: CardView = itemView.findViewById(R.id.cardView)
        
        fun bind(item: String) {
            textView.text = item
            
            // 应用主题颜色
            textView.setTextColor(themeManager.getThemeColor(itemView.context, R.attr.textColorPrimary))
            cardView.setCardBackgroundColor(themeManager.getThemeColor(itemView.context, R.attr.colorSurface))
            cardView.strokeColor = themeManager.getThemeColor(itemView.context, R.attr.colorBorder)
        }
    }
}
```

## 📱 完整应用示例

### 1. 主Activity示例

```kotlin
@AndroidEntryPoint
class MainActivity : BaseActivity<ActivityMainBinding>() {
    
    override val bindingInflater = ActivityMainBinding::inflate
    
    @Inject
    lateinit var injectedThemeManager: ThemeManager
    
    override fun initView() {
        super.themeManager = injectedThemeManager
        setupViews()
        setupClickListeners()
    }
    
    private fun setupViews() {
        // 设置主题颜色
        binding.textView.setThemeTextColor()
        binding.imageView.setThemeTint()
        binding.button.setBackgroundResource(R.drawable.bg_button_primary_pressed)
    }
    
    private fun setupClickListeners() {
        binding.button.setOnClickListener {
            // 跳转到主题设置页面
            startActivity(Intent(this, ThemeSettingsActivity::class.java))
        }
    }
}
```

### 2. 主题设置布局示例

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="?attr/colorBackground"
    android:orientation="vertical">

    <!-- 标题栏 -->
    <include
        android:id="@+id/titleBar"
        layout="@layout/layout_title_bar" />

    <!-- 滚动内容 -->
    <ScrollView
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:fillViewport="true">

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            android:padding="16dp">

            <!-- 主题选择 -->
            <TextView
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="主题选择"
                android:textColor="?attr/textColorPrimary"
                android:textSize="18sp"
                android:textStyle="bold" />

            <RadioGroup
                android:id="@+id/radioGroupTheme"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_marginTop="16dp"
                android:orientation="vertical">

                <RadioButton
                    android:id="@+id/rbDefault"
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:layout_marginBottom="8dp"
                    android:background="@drawable/bg_surface_rounded"
                    android:padding="16dp"
                    android:text="默认主题"
                    android:textColor="?attr/textColorPrimary"
                    android:textSize="16sp" />

                <RadioButton
                    android:id="@+id/rbBusiness"
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:layout_marginBottom="8dp"
                    android:background="@drawable/bg_surface_rounded"
                    android:padding="16dp"
                    android:text="商务主题"
                    android:textColor="?attr/textColorPrimary"
                    android:textSize="16sp" />

                <RadioButton
                    android:id="@+id/rbVibrant"
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:background="@drawable/bg_surface_rounded"
                    android:padding="16dp"
                    android:text="活力主题"
                    android:textColor="?attr/textColorPrimary"
                    android:textSize="16sp" />

            </RadioGroup>

            <!-- 暗黑模式设置 -->
            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:layout_marginTop="32dp"
                android:background="@drawable/bg_surface_rounded"
                android:gravity="center_vertical"
                android:padding="16dp">

                <LinearLayout
                    android:layout_width="0dp"
                    android:layout_height="wrap_content"
                    android:layout_weight="1"
                    android:orientation="vertical">

                    <TextView
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:text="暗黑模式"
                        android:textColor="?attr/textColorPrimary"
                        android:textSize="16sp" />

                    <TextView
                        android:layout_width="wrap_content"
                        android:layout_height="wrap_content"
                        android:layout_marginTop="4dp"
                        android:text="启用暗黑模式"
                        android:textColor="?attr/textColorSecondary"
                        android:textSize="14sp" />

                </LinearLayout>

                <Switch
                    android:id="@+id/switchDarkMode"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content" />

            </LinearLayout>

        </LinearLayout>

    </ScrollView>

</LinearLayout>
```

## 🔧 调试和测试示例

### 1. 主题测试工具

```kotlin
class ThemeTestHelper(private val context: Context) {
    
    fun testAllThemes() {
        val themes = listOf(AppTheme.DEFAULT, AppTheme.BUSINESS, AppTheme.VIBRANT)
        
        themes.forEach { theme ->
            Log.d("ThemeTest", "Testing theme: ${theme.themeName}")
            testThemeColors(theme)
        }
    }
    
    private fun testThemeColors(theme: AppTheme) {
        // 测试主色
        val primaryColor = context.getPrimaryColor()
        Log.d("ThemeTest", "Primary color: ${Integer.toHexString(primaryColor)}")
        
        // 测试文本色
        val textColor = context.getTextPrimaryColor()
        Log.d("ThemeTest", "Text color: ${Integer.toHexString(textColor)}")
        
        // 测试背景色
        val backgroundColor = context.getBackgroundColor()
        Log.d("ThemeTest", "Background color: ${Integer.toHexString(backgroundColor)}")
    }
}
```

### 2. 颜色对比度测试

```kotlin
class ContrastTestHelper {
    
    fun testContrastRatio(foreground: Int, background: Int): Double {
        val fgLuminance = getLuminance(foreground)
        val bgLuminance = getLuminance(background)
        
        val lighter = maxOf(fgLuminance, bgLuminance)
        val darker = minOf(fgLuminance, bgLuminance)
        
        return (lighter + 0.05) / (darker + 0.05)
    }
    
    private fun getLuminance(color: Int): Double {
        val red = (color shr 16) and 0xFF
        val green = (color shr 8) and 0xFF
        val blue = color and 0xFF
        
        val r = red / 255.0
        val g = green / 255.0
        val b = blue / 255.0
        
        val rLinear = if (r <= 0.03928) r / 12.92 else Math.pow((r + 0.055) / 1.055, 2.4)
        val gLinear = if (g <= 0.03928) g / 12.92 else Math.pow((g + 0.055) / 1.055, 2.4)
        val bLinear = if (b <= 0.03928) b / 12.92 else Math.pow((b + 0.055) / 1.055, 2.4)
        
        return 0.2126 * rLinear + 0.7152 * gLinear + 0.0722 * bLinear
    }
}
```

---

*本文档最后更新时间: 2024年10月*
